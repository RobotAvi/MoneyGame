name: 🚀 Create Release

on:
  push:
    tags:
      - 'v*'  # Запускается при создании тега вида v1.0.0

jobs:
  release:
    name: 🎉 Create Release APK
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: ☕ Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: 📱 Set up Android SDK
      uses: android-actions/setup-android@v2
        
    - name: 🔧 Install Android SDK components
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-34"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;34.0.0"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platform-tools"
        
    - name: 🎯 Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: 📦 Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: 🏗️ Build Release APK
      run: ./gradlew assembleRelease --stacktrace
      
    - name: 📋 Get version info
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "🏷️ Building version: $VERSION"
        
    - name: 📋 Get APK info
      id: apk_info
      run: |
        DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
        RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
        
        if [ -f "$RELEASE_APK" ]; then
          APK_PATH=$RELEASE_APK
          APK_TYPE="release"
        else
          APK_PATH=$DEBUG_APK
          APK_TYPE="debug"
        fi
        
        APK_SIZE=$(ls -lh $APK_PATH | awk '{print $5}')
        APK_NAME="FinancialSuccess-${{ steps.version.outputs.version }}.apk"
        
        # Переименовываем APK
        cp $APK_PATH $APK_NAME
        
        echo "apk_path=$APK_NAME" >> $GITHUB_OUTPUT
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        echo "apk_type=$APK_TYPE" >> $GITHUB_OUTPUT
        echo "📱 APK ready: $APK_NAME ($APK_SIZE, $APK_TYPE)"
        
    - name: 📝 Generate changelog
      id: changelog
      run: |
        # Получаем изменения с последнего тега
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | head -20)
        else
          CHANGELOG=$(git log --pretty=format:"- %s" | head -10)
        fi
        
        # Создаем красивый changelog
        cat > changelog.md << EOF
        🎮 **Игра "Финансовый успех" ${{ steps.version.outputs.version }}**
        
        📱 **Скачать APK:** [FinancialSuccess-${{ steps.version.outputs.version }}.apk](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/FinancialSuccess-${{ steps.version.outputs.version }}.apk)
        
        📊 **Информация:**
        - 📦 Размер: ${{ steps.apk_info.outputs.apk_size }}
        - 🔧 Тип сборки: ${{ steps.apk_info.outputs.apk_type }}
        - 📱 Совместимость: Android 7.0+ (API 24+)
        - 🎯 Архитектура: Universal APK
        
        ## 📋 Изменения в этой версии:
        
        $CHANGELOG
        
        ## 🎮 Что в игре:
        
        ✅ **Образовательная игра** по финансовой грамотности  
        ✅ **6 профессий** с реальными российскими зарплатами  
        ✅ **6 мечт** от яхты до космического туризма  
        ✅ **Инвестиции** в недвижимость, акции, бизнес, криптовалюту  
        ✅ **Двухуровневая система** "крысиные бега" → "скоростная дорожка"  
        ✅ **Детализированные отчёты** доходов и расходов  
        ✅ **ROI расчёты** для всех активов  
        ✅ **Material Design 3** интерфейс  
        
        ## 📲 Установка:
        
        1. Скачайте APK файл
        2. Разрешите установку из неизвестных источников
        3. Установите APK на Android устройство
        4. Играйте и изучайте финансовую грамотность!
        
        ---
        
        🎯 **Цель игры:** Выйти из "крысиных бегов", создав пассивный доход больше расходов, а затем осуществить свою финансовую мечту!
        EOF
        
    - name: 🎉 Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: 🎮 Финансовый успех ${{ steps.version.outputs.version }}
        body_path: changelog.md
        files: ${{ steps.apk_info.outputs.apk_path }}
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 📢 Release created
      run: |
        echo "🎉 Release created successfully!"
        echo "🔗 URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        echo "📱 APK: ${{ steps.apk_info.outputs.apk_name }}"
        echo "📦 Size: ${{ steps.apk_info.outputs.apk_size }}"