name: ðŸš€ Create Release

on:
  push:
    tags:
      - 'v*'  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚ÐµÐ³Ð° Ð²Ð¸Ð´Ð° v1.0.0

jobs:
  release:
    name: ðŸŽ‰ Create Release APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: ðŸ“± Set up Android SDK
      uses: android-actions/setup-android@v2
        
    - name: ðŸ”§ Install Android SDK components
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-34"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;34.0.0"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platform-tools"
        
    - name: ðŸŽ¯ Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: ðŸ“¦ Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ðŸ—ï¸ Build Release APK
      run: ./gradlew assembleRelease --stacktrace
      
    - name: ðŸ“‹ Get version info
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ·ï¸ Building version: $VERSION"
        
    - name: ðŸ“‹ Get APK info
      id: apk_info
      run: |
        DEBUG_APK=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
        RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
        
        if [ -f "$RELEASE_APK" ]; then
          APK_PATH=$RELEASE_APK
          APK_TYPE="release"
        else
          APK_PATH=$DEBUG_APK
          APK_TYPE="debug"
        fi
        
        APK_SIZE=$(ls -lh $APK_PATH | awk '{print $5}')
        APK_NAME="FinancialSuccess-${{ steps.version.outputs.version }}.apk"
        
        # ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ APK
        cp $APK_PATH $APK_NAME
        
        echo "apk_path=$APK_NAME" >> $GITHUB_OUTPUT
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        echo "apk_type=$APK_TYPE" >> $GITHUB_OUTPUT
        echo "ðŸ“± APK ready: $APK_NAME ($APK_SIZE, $APK_TYPE)"
        
    - name: ðŸ“ Generate changelog
      id: changelog
      run: |
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ñ‚ÐµÐ³Ð°
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | head -20)
        else
          CHANGELOG=$(git log --pretty=format:"- %s" | head -10)
        fi
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ changelog
        cat > changelog.md << EOF
        ðŸŽ® **Ð˜Ð³Ñ€Ð° "Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ ÑƒÑÐ¿ÐµÑ…" ${{ steps.version.outputs.version }}**
        
        ðŸ“± **Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ APK:** [FinancialSuccess-${{ steps.version.outputs.version }}.apk](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/FinancialSuccess-${{ steps.version.outputs.version }}.apk)
        
        ðŸ“Š **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:**
        - ðŸ“¦ Ð Ð°Ð·Ð¼ÐµÑ€: ${{ steps.apk_info.outputs.apk_size }}
        - ðŸ”§ Ð¢Ð¸Ð¿ ÑÐ±Ð¾Ñ€ÐºÐ¸: ${{ steps.apk_info.outputs.apk_type }}
        - ðŸ“± Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: Android 7.0+ (API 24+)
        - ðŸŽ¯ ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°: Universal APK
        
        ## ðŸ“‹ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² ÑÑ‚Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸:
        
        $CHANGELOG
        
        ## ðŸŽ® Ð§Ñ‚Ð¾ Ð² Ð¸Ð³Ñ€Ðµ:
        
        âœ… **ÐžÐ±Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð³Ñ€Ð°** Ð¿Ð¾ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð¾Ð¹ Ð³Ñ€Ð°Ð¼Ð¾Ñ‚Ð½Ð¾ÑÑ‚Ð¸  
        âœ… **6 Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¹** Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ€Ð¾ÑÑÐ¸Ð¹ÑÐºÐ¸Ð¼Ð¸ Ð·Ð°Ñ€Ð¿Ð»Ð°Ñ‚Ð°Ð¼Ð¸  
        âœ… **6 Ð¼ÐµÑ‡Ñ‚** Ð¾Ñ‚ ÑÑ…Ñ‚Ñ‹ Ð´Ð¾ ÐºÐ¾ÑÐ¼Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ‚ÑƒÑ€Ð¸Ð·Ð¼Ð°  
        âœ… **Ð˜Ð½Ð²ÐµÑÑ‚Ð¸Ñ†Ð¸Ð¸** Ð² Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚ÑŒ, Ð°ÐºÑ†Ð¸Ð¸, Ð±Ð¸Ð·Ð½ÐµÑ, ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ñƒ  
        âœ… **Ð”Ð²ÑƒÑ…ÑƒÑ€Ð¾Ð²Ð½ÐµÐ²Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°** "ÐºÑ€Ñ‹ÑÐ¸Ð½Ñ‹Ðµ Ð±ÐµÐ³Ð°" â†’ "ÑÐºÐ¾Ñ€Ð¾ÑÑ‚Ð½Ð°Ñ Ð´Ð¾Ñ€Ð¾Ð¶ÐºÐ°"  
        âœ… **Ð”ÐµÑ‚Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹** Ð´Ð¾Ñ…Ð¾Ð´Ð¾Ð² Ð¸ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð²  
        âœ… **ROI Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ñ‹** Ð´Ð»Ñ Ð²ÑÐµÑ… Ð°ÐºÑ‚Ð¸Ð²Ð¾Ð²  
        âœ… **Material Design 3** Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ  
        
        ## ðŸ“² Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:
        
        1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ APK Ñ„Ð°Ð¹Ð»
        2. Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Ð¸Ð· Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ñ… Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð²
        3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ APK Ð½Ð° Android ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾
        4. Ð˜Ð³Ñ€Ð°Ð¹Ñ‚Ðµ Ð¸ Ð¸Ð·ÑƒÑ‡Ð°Ð¹Ñ‚Ðµ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²ÑƒÑŽ Ð³Ñ€Ð°Ð¼Ð¾Ñ‚Ð½Ð¾ÑÑ‚ÑŒ!
        
        ---
        
        ðŸŽ¯ **Ð¦ÐµÐ»ÑŒ Ð¸Ð³Ñ€Ñ‹:** Ð’Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· "ÐºÑ€Ñ‹ÑÐ¸Ð½Ñ‹Ñ… Ð±ÐµÐ³Ð¾Ð²", ÑÐ¾Ð·Ð´Ð°Ð² Ð¿Ð°ÑÑÐ¸Ð²Ð½Ñ‹Ð¹ Ð´Ð¾Ñ…Ð¾Ð´ Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ€Ð°ÑÑ…Ð¾Ð´Ð¾Ð², Ð° Ð·Ð°Ñ‚ÐµÐ¼ Ð¾ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¸Ñ‚ÑŒ ÑÐ²Ð¾ÑŽ Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²ÑƒÑŽ Ð¼ÐµÑ‡Ñ‚Ñƒ!
        EOF
        
    - name: ðŸŽ‰ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ðŸŽ® Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ ÑƒÑÐ¿ÐµÑ… ${{ steps.version.outputs.version }}
        body_path: changelog.md
        files: ${{ steps.apk_info.outputs.apk_path }}
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“¢ Release created
      run: |
        echo "ðŸŽ‰ Release created successfully!"
        echo "ðŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        echo "ðŸ“± APK: ${{ steps.apk_info.outputs.apk_name }}"
        echo "ðŸ“¦ Size: ${{ steps.apk_info.outputs.apk_size }}"