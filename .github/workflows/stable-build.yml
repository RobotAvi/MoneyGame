name: ðŸš€ Stable Build & Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.configureondemand=true
  MAESTRO_CLI_ANALYSIS_NOTIFICATION_DISABLED: "true"

jobs:
  setup-android-sdk:
    runs-on: ubuntu-latest
    outputs:
      sdk-path: /home/runner/android-sdk
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
      date: ${{ steps.date.outputs.date }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸ“… Get current date
        id: date
        run: echo "date=$(date '+%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
      - name: ðŸ”– Get version info
        id: version
        run: |
          echo "ðŸ” ==== ÐŸÐžÐ›Ð£Ð§Ð•ÐÐ˜Ð• Ð’Ð•Ð Ð¡Ð˜Ð˜ ===="
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ app/build.gradle..."
          ls -la app/build.gradle || echo "âŒ app/build.gradle Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "ðŸ” Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ app/build.gradle:"
          cat app/build.gradle | grep -E "(versionName|versionCode)" || echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ versionName Ð¸Ð»Ð¸ versionCode"
          
          VERSION=$(grep -oP 'versionName\s+"\K[^"]+' app/build.gradle)
          VERSION_CODE=$(grep -oP 'versionCode\s+\K[0-9]+' app/build.gradle)
          
          echo "ðŸ” Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: $VERSION"
          echo "ðŸ” Ð˜Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ Ð²ÐµÑ€ÑÐ¸Ð¸: $VERSION_CODE"
          
          if [ -z "$VERSION" ]; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ versionName"
            exit 1
          fi
          if [ -z "$VERSION_CODE" ]; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð·Ð²Ð»ÐµÑ‡ÑŒ versionCode"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "âœ… Ð’ÐµÑ€ÑÐ¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð°: $VERSION ($VERSION_CODE)"
      - name: ðŸ—ï¸ Prepare Android SDK directories
        id: set-sdk-path
        run: |
          echo "sdk_path=/home/runner/android-sdk" >> $GITHUB_OUTPUT
          mkdir -p /home/runner/android-sdk
          echo "ANDROID_SDK_ROOT=/home/runner/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_HOME=/home/runner/android-sdk" >> $GITHUB_ENV
      - name: ðŸ› ï¸ Download and install Android commandline tools
        run: |
          echo "ðŸ”§ ==== Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ ANDROID COMMANDLINE TOOLS ===="
          set -x
          
          echo "ðŸ”§ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
          sudo apt-get update
          
          echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° wget Ð¸ unzip..."
          sudo apt-get install -y wget unzip
          
          echo "ðŸ”§ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° commandline tools..."
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          echo "ðŸ”§ Ð Ð°Ð·Ð¼ÐµÑ€ ÑÐºÐ°Ñ‡Ð°Ð½Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°:"
          ls -la cmdline-tools.zip
          
          echo "ðŸ”§ Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° commandline tools..."
          unzip cmdline-tools.zip -d $HOME
          echo "ðŸ”§ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ $HOME Ð¿Ð¾ÑÐ»Ðµ Ñ€Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ¸:"
          ls -la $HOME/ | grep cmdline
          
          echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
          mkdir -p $HOME/android-sdk/cmdline-tools
          mv $HOME/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          
          echo "ðŸ”§ ==== Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð CMDLINE-TOOLS ===="
          find $HOME/android-sdk/cmdline-tools/ -type f | head -20
          echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° sdkmanager:"
          ls -la $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager || echo "âŒ sdkmanager Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
      - name: ðŸ› ï¸ Install Android SDK components
        run: |
          echo "ðŸ”§ ==== Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢ÐžÐ’ ANDROID SDK ===="
          set -x
          
          echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
          export ANDROID_SDK_ROOT=/home/runner/android-sdk
          export ANDROID_HOME=/home/runner/android-sdk
          export PATH="$PATH:/home/runner/android-sdk/emulator:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/cmdline-tools/latest/bin"
          
          echo "ðŸ”§ ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ðŸ”§ ANDROID_HOME: $ANDROID_HOME"
          echo "ðŸ”§ PATH: $PATH"
          
          echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° sdkmanager Ð¿ÐµÑ€ÐµÐ´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹..."
          which sdkmanager || echo "âŒ sdkmanager Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² PATH"
          ls -la $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager || echo "âŒ sdkmanager Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ Ð¿ÑƒÑ‚Ð¸"
          
          echo "ðŸ”§ ÐŸÑ€Ð¸Ð½ÑÑ‚Ð¸Ðµ Ð»Ð¸Ñ†ÐµÐ½Ð·Ð¸Ð¹..."
          yes | sdkmanager --licenses || { echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: sdkmanager license error"; exit 1; }
          
          echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² SDK..."
          echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼: platform-tools, emulator, system-images;android-34;default;x86_64"
          sdkmanager "platform-tools" "emulator" "system-images;android-34;default;x86_64" || { echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: sdkmanager install error"; exit 1; }
          
          echo "ðŸ”§ ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð£Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐÐ«Ð¥ ÐšÐžÐœÐŸÐžÐÐ•ÐÐ¢ÐžÐ’ ===="
          echo "ðŸ”§ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° SDK Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸:"
          find $ANDROID_SDK_ROOT/ -type d | head -20
          
          echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° platform-tools:"
          ls -la $ANDROID_SDK_ROOT/platform-tools/ || echo "âŒ platform-tools Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° emulator:"
          ls -la $ANDROID_SDK_ROOT/emulator/ || echo "âŒ emulator Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° system-images:"
          find $ANDROID_SDK_ROOT/system-images/ -type f | head -10 || echo "âŒ system-images Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
          echo "ðŸ”§ ==== Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ ÐŸÐ ÐÐ’ ÐÐ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• ===="
          echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ SDK Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
          chmod +x $ANDROID_SDK_ROOT/platform-tools/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ platform-tools"
          chmod +x $ANDROID_SDK_ROOT/emulator/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ emulator"
          chmod +x $ANDROID_SDK_ROOT/emulator/qemu/linux-x86_64/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ qemu"
          chmod +x $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ cmdline-tools"
          
          echo "ðŸ”§ ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐŸÐ ÐÐ’ ÐÐ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• ===="
          echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° adb:"
          ls -la $ANDROID_SDK_ROOT/platform-tools/adb || echo "âŒ adb Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° emulator:"
          ls -la $ANDROID_SDK_ROOT/emulator/emulator || echo "âŒ emulator Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° avdmanager:"
          ls -la $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager || echo "âŒ avdmanager Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          
          echo "ðŸ”§ ==== Ð¤Ð˜ÐÐÐ›Ð¬ÐÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ===="
          echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° system-images Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸:"
          find $ANDROID_SDK_ROOT/system-images/ || echo "âŒ system-images dir not found"
          
          echo "ðŸ”§ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´:"
          $ANDROID_SDK_ROOT/platform-tools/adb version || echo "âŒ adb version failed"
          $ANDROID_SDK_ROOT/emulator/emulator -version || echo "âŒ emulator version failed"
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager list avd || echo "âŒ avdmanager failed"
      - name: ðŸ“¦ Upload Android SDK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-sdk
          path: ${{ env.ANDROID_SDK_ROOT }}

  # ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°
  screenshots-phone:
    runs-on: ubuntu-latest
    needs: setup-android-sdk
    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_HOME: /home/runner/android-sdk
    # Ð£Ð±Ñ€Ð°Ð½Ð¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ should_release
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download Android SDK artifact
      uses: actions/download-artifact@v4
      with:
        name: android-sdk
        path: ${{ env.ANDROID_SDK_ROOT }}
    - name: ðŸ§¾ Log Android SDK structure
      run: |
        echo "ðŸ” ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð—ÐÐ“Ð Ð£Ð–Ð•ÐÐÐžÐ“Ðž ANDROID SDK (PHONE) ===="
        echo "ðŸ” ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸:"
        ls -la $ANDROID_SDK_ROOT/ || echo "âŒ ANDROID_SDK_ROOT Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
        
        echo "ðŸ” ==== Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð SDK ===="
        find $ANDROID_SDK_ROOT/ -type d | head -20
        
        echo "ðŸ” ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð¥ Ð¤ÐÐ™Ð›ÐžÐ’ ===="
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° adb:"
        ls -la $ANDROID_SDK_ROOT/platform-tools/adb || echo "âŒ adb Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° emulator:"
        ls -la $ANDROID_SDK_ROOT/emulator/emulator || echo "âŒ emulator Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° avdmanager:"
        ls -la $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager || echo "âŒ avdmanager Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° system-images:"
        find $ANDROID_SDK_ROOT/system-images/ -name "*.img" | head -5 || echo "âŒ system-images Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        
        echo "ðŸ” ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐŸÐ ÐÐ’ ÐÐ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• ===="
        echo "ðŸ” ÐŸÑ€Ð°Ð²Ð° Ð½Ð° adb:"
        ls -la $ANDROID_SDK_ROOT/platform-tools/adb | grep -E "^-r.x" || echo "âŒ adb Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ” ÐŸÑ€Ð°Ð²Ð° Ð½Ð° emulator:"
        ls -la $ANDROID_SDK_ROOT/emulator/emulator | grep -E "^-r.x" || echo "âŒ emulator Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ” ÐŸÑ€Ð°Ð²Ð° Ð½Ð° avdmanager:"
        ls -la $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager | grep -E "^-r.x" || echo "âŒ avdmanager Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
    
    - name: ðŸ”§ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ (Phone)
      run: |
        echo "ðŸ”§ ==== Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÐŸÐ ÐÐ’ ÐÐ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• ===="
        echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð²ÑÐµÑ… SDK Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
        
        chmod +x $ANDROID_SDK_ROOT/platform-tools/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ platform-tools"
        chmod +x $ANDROID_SDK_ROOT/emulator/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ emulator"
        chmod +x $ANDROID_SDK_ROOT/emulator/qemu/linux-x86_64/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ qemu"
        chmod +x $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ cmdline-tools"
        
        echo "ðŸ”§ ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐŸÐ ÐÐ’ ÐŸÐžÐ¡Ð›Ð• Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð¯ ===="
        echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° adb:"
        ls -la $ANDROID_SDK_ROOT/platform-tools/adb | grep -E "^-r.x" || echo "âŒ adb Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° emulator:"
        ls -la $ANDROID_SDK_ROOT/emulator/emulator | grep -E "^-r.x" || echo "âŒ emulator Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° avdmanager:"
        ls -la $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager | grep -E "^-r.x" || echo "âŒ avdmanager Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ”§ ==== Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• ÐšÐžÐœÐÐÐ” ===="
        echo "ðŸ”§ Ð¢ÐµÑÑ‚ adb:"
        $ANDROID_SDK_ROOT/platform-tools/adb version || echo "âŒ adb version failed"
        
        echo "ðŸ”§ Ð¢ÐµÑÑ‚ emulator:"
        $ANDROID_SDK_ROOT/emulator/emulator -version || echo "âŒ emulator version failed"
        
        echo "ðŸ”§ Ð¢ÐµÑÑ‚ avdmanager:"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager list avd || echo "âŒ avdmanager failed"

    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ adb Ð² PATH (phone)
      run: |
        echo "ðŸ” Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ adb..."
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y libc6:i386 libstdc++6:i386 lib32z1 lib32stdc++6
        
        echo "ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PATH Ð´Ð»Ñ adb..."
        export PATH="$PATH:/home/runner/android-sdk/platform-tools"
        echo "PATH: $PATH"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ adb..."
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° adb..."
        ls -la /home/runner/android-sdk/platform-tools/adb || echo "âŒ Ð¤Ð°Ð¹Ð» adb Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ..."
        file /home/runner/android-sdk/platform-tools/adb || echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ð°"
        
        echo "ðŸ” ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° adb Ð¿Ð¾ Ð¿Ð¾Ð»Ð½Ð¾Ð¼Ñƒ Ð¿ÑƒÑ‚Ð¸..."
        /home/runner/android-sdk/platform-tools/adb version || echo "âŒ adb version failed"
        
        echo "ðŸ” ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° adb Ñ‡ÐµÑ€ÐµÐ· which..."
        which adb || echo "âŒ which adb failed"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº adb..."
        ldd /home/runner/android-sdk/platform-tools/adb || echo "âŒ ldd failed"

    - name: ðŸŽ­ Install Maestro
      run: |
        curl -Ls "https://get.maestro.mobile.dev" | bash
        export PATH="$PATH:$HOME/.maestro/bin"
        echo "n" | maestro --version

    - name: ðŸ“± Start Android Emulator and Install APK (Phone)
      shell: bash
      env:
        ANDROID_SDK_ROOT: /home/runner/android-sdk
        ANDROID_HOME: /home/runner/android-sdk
      run: |
        export PATH="$PATH:/home/runner/android-sdk/emulator:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/cmdline-tools/latest/bin"
        set -e
        echo "SDK root: $ANDROID_SDK_ROOT"
        echo "PATH: $PATH"
        ls -la $ANDROID_SDK_ROOT/system-images/android-34/default/x86_64/
        rm -rf ~/.android/avd/*

        # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ AVD, ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if ! avdmanager list avd | grep -q "ci_nexus5"; then
          echo "no" | avdmanager create avd --name "ci_nexus5" --package "system-images;android-34;default;x86_64" --device "Nexus 5"
        fi

        # Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° Ð² Ñ„Ð¾Ð½Ðµ
        emulator -avd "ci_nexus5" -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel off -no-snapshot -no-metrics &
        EMULATOR_PID=$!

        # ÐŸÐ°ÑƒÐ·Ð° Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° (Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ CI)
        sleep 30

        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ð² adb (Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 120Ñ)
        emulator_timeout=120
        emulator_elapsed=0
        for i in {1..60}; do
          if adb devices | grep -q "emulator"; then
            echo "âœ… Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð¿Ð¾ÑÐ²Ð¸Ð»ÑÑ Ð² adb"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð·Ð° $emulator_timeout ÑÐµÐºÑƒÐ½Ð´"
            kill $EMULATOR_PID 2>/dev/null || true
            exit 1
          fi
          sleep 2
          emulator_elapsed=$((emulator_elapsed + 2))
          if [ $((emulator_elapsed % 30)) -eq 0 ]; then
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°: $emulator_elapsed ÑÐµÐºÑƒÐ½Ð´ Ð¸Ð· $emulator_timeout..."
          fi
        done

        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Android (sys.boot_completed, Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 180Ñ)
        boot_timeout=180
        boot_elapsed=0
        for i in {1..90}; do
          if adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ… Android Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
            break
          fi
          if [ $i -eq 90 ]; then
            echo "âŒ Android Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ Ð·Ð° $boot_timeout ÑÐµÐºÑƒÐ½Ð´"
            kill $EMULATOR_PID 2>/dev/null || true
            exit 1
          fi
          sleep 2
          boot_elapsed=$((boot_elapsed + 2))
          if [ $((boot_elapsed % 30)) -eq 0 ]; then
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Android: $boot_elapsed ÑÐµÐºÑƒÐ½Ð´ Ð¸Ð· $boot_timeout..."
          fi
        done

        # Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° ÑÐºÑ€Ð°Ð½Ð°
        adb shell input keyevent 82
        adb shell input keyevent 82
        sleep 2

        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° APK
        if [ ! -f "releases/debug/latest-debug.apk" ]; then
          echo "âŒ Error: latest-debug.apk not found in releases/debug/"
          ls -la releases/debug/
          kill $EMULATOR_PID 2>/dev/null || true
          exit 1
        fi
        adb install releases/debug/latest-debug.apk
        if adb shell pm list packages | grep -q financialsuccess; then
          echo "âœ… APK ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        else
          echo "âŒ Error: APK installation failed"
          kill $EMULATOR_PID 2>/dev/null || true
          exit 1
        fi

        # ... ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ ÑÐ½Ð¸Ð¼Ð°Ñ‚ÑŒÑÑ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑˆÐ°Ð³Ð¾Ð¼ ...

        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
        kill $EMULATOR_PID 2>/dev/null || true
        pkill -f emulator 2>/dev/null || true

    - name: ðŸ“¸ Run Maestro Screenshots (Phone)
      run: |
        export PATH="$PATH:$HOME/.maestro/bin"
        mkdir -p screenshots/phone
        
        # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°
        local config_file="maestro/screenshots-stable.yaml"
        if [ ! -f "$config_file" ]; then
          config_file="maestro/screenshots.yaml"
        fi
        
        if [ -f "$config_file" ]; then
          echo "Using phone screenshots configuration: $config_file"
          maestro test "$config_file" --format junit --output screenshots/phone/
          echo "ðŸ“± Phone screenshots completed!"
        else
          echo "âš ï¸ Warning: Maestro configuration file not found: $config_file"
          echo "ðŸ“± Phone screenshots skipped!"
        fi

    - name: ðŸ“¤ Upload Phone Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: phone-screenshots-v${{ needs.setup-android-sdk.outputs.version }}
        path: screenshots/phone/
        retention-days: 30

  # ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð¿Ð»Ð°Ð½ÑˆÐµÑ‚Ð°
  screenshots-tablet:
    runs-on: ubuntu-latest
    needs: setup-android-sdk
    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_HOME: /home/runner/android-sdk
    # Ð£Ð±Ñ€Ð°Ð½Ð¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ should_release
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download Android SDK artifact
      uses: actions/download-artifact@v4
      with:
        name: android-sdk
        path: ${{ env.ANDROID_SDK_ROOT }}
    - name: ðŸ§¾ Log Android SDK structure
      run: |
        echo "ðŸ” ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð—ÐÐ“Ð Ð£Ð–Ð•ÐÐÐžÐ“Ðž ANDROID SDK (TABLET) ===="
        echo "ðŸ” ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸:"
        ls -la $ANDROID_SDK_ROOT/ || echo "âŒ ANDROID_SDK_ROOT Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
        
        echo "ðŸ” ==== Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð SDK ===="
        find $ANDROID_SDK_ROOT/ -type d | head -20
        
        echo "ðŸ” ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð¥ Ð¤ÐÐ™Ð›ÐžÐ’ ===="
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° adb:"
        ls -la $ANDROID_SDK_ROOT/platform-tools/adb || echo "âŒ adb Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° emulator:"
        ls -la $ANDROID_SDK_ROOT/emulator/emulator || echo "âŒ emulator Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° avdmanager:"
        ls -la $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager || echo "âŒ avdmanager Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° system-images:"
        find $ANDROID_SDK_ROOT/system-images/ -name "*.img" | head -5 || echo "âŒ system-images Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        
        echo "ðŸ” ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐŸÐ ÐÐ’ ÐÐ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• ===="
        echo "ðŸ” ÐŸÑ€Ð°Ð²Ð° Ð½Ð° adb:"
        ls -la $ANDROID_SDK_ROOT/platform-tools/adb | grep -E "^-r.x" || echo "âŒ adb Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ” ÐŸÑ€Ð°Ð²Ð° Ð½Ð° emulator:"
        ls -la $ANDROID_SDK_ROOT/emulator/emulator | grep -E "^-r.x" || echo "âŒ emulator Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ” ÐŸÑ€Ð°Ð²Ð° Ð½Ð° avdmanager:"
        ls -la $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager | grep -E "^-r.x" || echo "âŒ avdmanager Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
    
    - name: ðŸ”§ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ (Tablet)
      run: |
        echo "ðŸ”§ ==== Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÐŸÐ ÐÐ’ ÐÐ Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð• ===="
        echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð²ÑÐµÑ… SDK Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
        
        chmod +x $ANDROID_SDK_ROOT/platform-tools/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ platform-tools"
        chmod +x $ANDROID_SDK_ROOT/emulator/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ emulator"
        chmod +x $ANDROID_SDK_ROOT/emulator/qemu/linux-x86_64/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ qemu"
        chmod +x $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/* || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð»Ñ cmdline-tools"
        
        echo "ðŸ”§ ==== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ ÐŸÐ ÐÐ’ ÐŸÐžÐ¡Ð›Ð• Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð¯ ===="
        echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° adb:"
        ls -la $ANDROID_SDK_ROOT/platform-tools/adb | grep -E "^-r.x" || echo "âŒ adb Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° emulator:"
        ls -la $ANDROID_SDK_ROOT/emulator/emulator | grep -E "^-r.x" || echo "âŒ emulator Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ”§ ÐŸÑ€Ð°Ð²Ð° Ð½Ð° avdmanager:"
        ls -la $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager | grep -E "^-r.x" || echo "âŒ avdmanager Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ"
        
        echo "ðŸ”§ ==== Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• ÐšÐžÐœÐÐÐ” ===="
        echo "ðŸ”§ Ð¢ÐµÑÑ‚ adb:"
        $ANDROID_SDK_ROOT/platform-tools/adb version || echo "âŒ adb version failed"
        
        echo "ðŸ”§ Ð¢ÐµÑÑ‚ emulator:"
        $ANDROID_SDK_ROOT/emulator/emulator -version || echo "âŒ emulator version failed"
        
        echo "ðŸ”§ Ð¢ÐµÑÑ‚ avdmanager:"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager list avd || echo "âŒ avdmanager failed"

    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ adb Ð² PATH (tablet)
      run: |
        echo "ðŸ” Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ adb..."
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y libc6:i386 libstdc++6:i386 lib32z1 lib32stdc++6
        
        echo "ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PATH Ð´Ð»Ñ adb..."
        export PATH="$PATH:/home/runner/android-sdk/platform-tools"
        echo "PATH: $PATH"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ adb..."
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° adb..."
        ls -la /home/runner/android-sdk/platform-tools/adb || echo "âŒ Ð¤Ð°Ð¹Ð» adb Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ..."
        file /home/runner/android-sdk/platform-tools/adb || echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ð¿ Ñ„Ð°Ð¹Ð»Ð°"
        
        echo "ðŸ” ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° adb Ð¿Ð¾ Ð¿Ð¾Ð»Ð½Ð¾Ð¼Ñƒ Ð¿ÑƒÑ‚Ð¸..."
        /home/runner/android-sdk/platform-tools/adb version || echo "âŒ adb version failed"
        
        echo "ðŸ” ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° adb Ñ‡ÐµÑ€ÐµÐ· which..."
        which adb || echo "âŒ which adb failed"
        
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº adb..."
        ldd /home/runner/android-sdk/platform-tools/adb || echo "âŒ ldd failed"

    - name: ðŸŽ­ Install Maestro
      run: |
        curl -Ls "https://get.maestro.mobile.dev" | bash
        export PATH="$PATH:$HOME/.maestro/bin"
        echo "n" | maestro --version

    - name: ðŸ“± Start Android Emulator and Install APK (Tablet)
      shell: bash
      env:
        ANDROID_SDK_ROOT: /home/runner/android-sdk
        ANDROID_HOME: /home/runner/android-sdk
      run: |
        export PATH="$PATH:/home/runner/android-sdk/emulator:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/cmdline-tools/latest/bin"
        set -e
        echo "SDK root: $ANDROID_SDK_ROOT"
        echo "PATH: $PATH"
        ls -la $ANDROID_SDK_ROOT/system-images/android-34/default/x86_64/
        rm -rf ~/.android/avd/*

        # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ AVD, ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if ! avdmanager list avd | grep -q "ci_nexus10"; then
          echo "no" | avdmanager create avd --name "ci_nexus10" --package "system-images;android-34;default;x86_64" --device "Nexus 10"
        fi

        # Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° Ð² Ñ„Ð¾Ð½Ðµ
        emulator -avd "ci_nexus10" -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel off -no-snapshot -no-metrics &
        EMULATOR_PID=$!

        # ÐŸÐ°ÑƒÐ·Ð° Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° (Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ CI)
        sleep 30

        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ð² adb (Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 120Ñ)
        emulator_timeout=120
        emulator_elapsed=0
        for i in {1..60}; do
          if adb devices | grep -q "emulator"; then
            echo "âœ… Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð¿Ð¾ÑÐ²Ð¸Ð»ÑÑ Ð² adb"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð·Ð° $emulator_timeout ÑÐµÐºÑƒÐ½Ð´"
            kill $EMULATOR_PID 2>/dev/null || true
            exit 1
          fi
          sleep 2
          emulator_elapsed=$((emulator_elapsed + 2))
          if [ $((emulator_elapsed % 30)) -eq 0 ]; then
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°: $emulator_elapsed ÑÐµÐºÑƒÐ½Ð´ Ð¸Ð· $emulator_timeout..."
          fi
        done

        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Android (sys.boot_completed, Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 180Ñ)
        boot_timeout=180
        boot_elapsed=0
        for i in {1..90}; do
          if adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ… Android Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
            break
          fi
          if [ $i -eq 90 ]; then
            echo "âŒ Android Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ Ð·Ð° $boot_timeout ÑÐµÐºÑƒÐ½Ð´"
            kill $EMULATOR_PID 2>/dev/null || true
            exit 1
          fi
          sleep 2
          boot_elapsed=$((boot_elapsed + 2))
          if [ $((boot_elapsed % 30)) -eq 0 ]; then
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Android: $boot_elapsed ÑÐµÐºÑƒÐ½Ð´ Ð¸Ð· $boot_timeout..."
          fi
        done

        # Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° ÑÐºÑ€Ð°Ð½Ð°
        adb shell input keyevent 82
        adb shell input keyevent 82
        sleep 2

        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° APK
        if [ ! -f "releases/debug/latest-debug.apk" ]; then
          echo "âŒ Error: latest-debug.apk not found in releases/debug/"
          ls -la releases/debug/
          kill $EMULATOR_PID 2>/dev/null || true
          exit 1
        fi
        adb install releases/debug/latest-debug.apk
        if adb shell pm list packages | grep -q financialsuccess; then
          echo "âœ… APK ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        else
          echo "âŒ Error: APK installation failed"
          kill $EMULATOR_PID 2>/dev/null || true
          exit 1
        fi

        # ... ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ ÑÐ½Ð¸Ð¼Ð°Ñ‚ÑŒÑÑ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑˆÐ°Ð³Ð¾Ð¼ ...

        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
        kill $EMULATOR_PID 2>/dev/null || true
        pkill -f emulator 2>/dev/null || true

    - name: ðŸ“¸ Run Maestro Screenshots (Tablet)
      run: |
        export PATH="$PATH:$HOME/.maestro/bin"
        mkdir -p screenshots/tablet
        
        # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ð»Ð°Ð½ÑˆÐµÑ‚Ð°
        local config_file="maestro/screenshots-tablet.yaml"
        if [ ! -f "$config_file" ]; then
          config_file="maestro/screenshots.yaml"
        fi
        
        if [ -f "$config_file" ]; then
          echo "Using tablet screenshots configuration: $config_file"
          maestro test "$config_file" --format junit --output screenshots/tablet/
          echo "ðŸ“± Tablet screenshots completed!"
        else
          echo "âš ï¸ Warning: Maestro configuration file not found: $config_file"
          echo "ðŸ“± Tablet screenshots skipped!"
        fi

    - name: ðŸ“¤ Upload Tablet Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: tablet-screenshots-v${{ needs.setup-android-sdk.outputs.version }}
        path: screenshots/tablet/
        retention-days: 30

  # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ñ€ÐµÐ»Ð¸Ð·Ð°
  create-release:
    runs-on: ubuntu-latest
    needs: [setup-android-sdk, screenshots-phone, screenshots-tablet]
    # Ð£Ð±Ñ€Ð°Ð½Ð¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ should_release
    permissions:
      contents: write

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: FinancialSuccess-v${{ needs.setup-android-sdk.outputs.version }}-${{ needs.setup-android-sdk.outputs.date }}

    - name: ðŸ“¥ Download Phone Screenshots
      uses: actions/download-artifact@v4
      with:
        name: phone-screenshots-v${{ needs.setup-android-sdk.outputs.version }}

    - name: ðŸ“¥ Download Tablet Screenshots
      uses: actions/download-artifact@v4
      with:
        name: tablet-screenshots-v${{ needs.setup-android-sdk.outputs.version }}

    - name: ðŸ“¸ Prepare screenshots for repository
      run: |
        mkdir -p screenshots/phone screenshots/tablet
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ð¿ÐºÐ¸
        if [ -d "screenshots/phone" ]; then
          cp -r screenshots/phone/* screenshots/phone/ 2>/dev/null || true
        fi
        if [ -d "screenshots/tablet" ]; then
          cp -r screenshots/tablet/* screenshots/tablet/ 2>/dev/null || true
        fi
        
        echo "ðŸ“± Phone screenshots:"
        ls -la screenshots/phone/ 2>/dev/null || echo "No phone screenshots"
        echo ""
        echo "ðŸ“± Tablet screenshots:"
        ls -la screenshots/tablet/ 2>/dev/null || echo "No tablet screenshots"

    - name: ðŸ“ Commit Screenshots to Repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add screenshots/
        if git diff --staged --quiet; then
          echo "No screenshots to commit"
        else
          git commit -m "ðŸ“¸ Auto-generated screenshots v${{ needs.setup-android-sdk.outputs.version }} - ${{ needs.setup-android-sdk.outputs.date }}
          
          ðŸ“± Screenshots:
          - Phone: $(ls screenshots/phone/*.png 2>/dev/null | wc -l) files
          - Tablet: $(ls screenshots/tablet/*.png 2>/dev/null | wc -l) files
          - Total: $(find screenshots/ -name "*.png" 2>/dev/null | wc -l) files"
          git push
        fi

    - name: ðŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.setup-android-sdk.outputs.version }}-${{ needs.setup-android-sdk.outputs.date }}
        name: "ðŸŽ® Financial Success v${{ needs.setup-android-sdk.outputs.version }}"
        body_path: RELEASE_NOTES.md
        files: |
          releases/debug/*.apk
          screenshots/phone/*.png
          screenshots/tablet/*.png
        draft: false
        prerelease: false
        generate_release_notes: false

    - name: ðŸ“Š Build Summary
      run: |
        echo "ðŸŽ‰ Release completed successfully!"
        echo ""
        echo "ï¿½ Results:"
        echo "ï¿½ï¿½ Version: ${{ needs.build-and-test.outputs.version }}"
        echo "ðŸ”¢ Version Code: ${{ needs.build-and-test.outputs.version_code }}"
        echo "ðŸ“… Date: ${{ needs.build-and-test.outputs.date }}"
        echo "ï¿½ APK: releases/debug/FinancialSuccess-v${{ needs.build-and-test.outputs.version }}-${{ needs.build-and-test.outputs.date }}-debug.apk"
        echo "ðŸ“¸ Phone screenshots: screenshots/phone/"
        echo "ðŸ“¸ Tablet screenshots: screenshots/tablet/"
        echo ""
        echo "ï¿½ Files:"
        ls -la releases/debug/ || echo "No APK files found"
        echo ""
        echo "ðŸ“¸ Phone screenshots:"
        ls -la screenshots/phone/ 2>/dev/null || echo "No phone screenshots"
        echo ""
        echo "ðŸ“¸ Tablet screenshots:"
        ls -la screenshots/tablet/ 2>/dev/null || echo "No tablet screenshots"
