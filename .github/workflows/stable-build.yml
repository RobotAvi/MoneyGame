name: ğŸš€ Stable Build & Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  ACTIONS_RUNNER_DEBUG: true
  RUNNER_DEBUG: 1
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.configureondemand=true

jobs:
  # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
      date: ${{ steps.date.outputs.date }}
      apk_path: ${{ steps.apk_path.outputs.path }}
      should_release: ${{ steps.should_release.outputs.value }}

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ changelog

    - name: ğŸ” Determine if this is a release build
      id: should_release
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "value=true" >> $GITHUB_OUTPUT
        else
          echo "value=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”– Bump version (only for releases)
      id: bump_version
      if: steps.should_release.outputs.value == 'true'
      run: |
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ
        CURR_VERSION=$(grep -oP 'versionName\s+"\K[^"]+' app/build.gradle)
        CURR_CODE=$(grep -oP 'versionCode\s+\K[0-9]+' app/build.gradle)
        
        # Ğ˜Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ minor Ğ²ĞµÑ€ÑĞ¸Ñ (x.y -> x.(y+1))
        MAJOR=$(echo $CURR_VERSION | cut -d. -f1)
        MINOR=$(echo $CURR_VERSION | cut -d. -f2)
        if [ -z "$MINOR" ]; then MINOR=0; fi
        NEW_MINOR=$((MINOR+1))
        NEW_VERSION="$MAJOR.$NEW_MINOR"
        NEW_CODE=$((CURR_CODE+1))
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ build.gradle
        sed -i "s/versionName \"$CURR_VERSION\"/versionName \"$NEW_VERSION\"/" app/build.gradle
        sed -i "s/versionCode $CURR_CODE/versionCode $NEW_CODE/" app/build.gradle
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_code=$NEW_CODE" >> $GITHUB_OUTPUT
        echo "Version bumped: $CURR_VERSION â†’ $NEW_VERSION ($CURR_CODE â†’ $NEW_CODE)"
        
        # ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add app/build.gradle
        git commit -m "ğŸ”– Bump version to $NEW_VERSION ($NEW_CODE) [auto]" || echo "No version change to commit"
        git push || echo "No changes to push"

    - name: ğŸ“ Generate release notes (only for releases)
      id: release_notes
      if: steps.should_release.outputs.value == 'true'
      run: |
        echo "## ğŸ® Financial Success v${{ steps.bump_version.outputs.new_version }}" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ğŸ“… Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ»Ğ¸Ğ·Ğ°: $(date '+%Y-%m-%d %H:%M UTC')" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ğŸ”„ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ:" >> RELEASE_NOTES.md
        git log --oneline -10 >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ğŸ“‹ Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¸Ğ· CHANGELOG.md:" >> RELEASE_NOTES.md
        if [ -f "docs/CHANGELOG.md" ]; then
          tail -n 20 docs/CHANGELOG.md >> RELEASE_NOTES.md
        fi
        cat RELEASE_NOTES.md

    - name: ğŸ“ Commit release notes (only for releases)
      if: steps.should_release.outputs.value == 'true'
      run: |
        git add RELEASE_NOTES.md
        git commit -m "ğŸ“ Update release notes [auto]" || echo "No release notes change to commit"
        git push || echo "No changes to push"

    - name: â˜• Setup JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: ğŸ“¦ Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/build-cache
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ğŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: ğŸ§ª Run Unit Tests
      run: ./gradlew test --no-daemon

    - name: ğŸ”¨ Build Debug APK
      run: ./gradlew assembleDebug --no-daemon

    - name: ğŸ“Š Get version info
      id: version
      run: |
        VERSION=$(grep -oP 'versionName\s+"\K[^"]+' app/build.gradle)
        VERSION_CODE=$(grep -oP 'versionCode\s+\K[0-9]+' app/build.gradle)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Version: $VERSION ($VERSION_CODE)"

    - name: ğŸ“… Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_OUTPUT

    - name: ğŸ“± Prepare APK for distribution
      id: apk_path
      run: |
        mkdir -p releases/debug
        cp app/build/outputs/apk/debug/app-debug.apk releases/debug/
        cd releases/debug
        
        # ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ Ğ²ĞµÑ€ÑĞ¸ĞµĞ¹ Ğ¸ Ğ´Ğ°Ñ‚Ğ¾Ğ¹
        newname="FinancialSuccess-v${{ steps.version.outputs.version }}-${{ steps.date.outputs.date }}-debug.apk"
        mv -f app-debug.apk "$newname"
        echo "path=releases/debug/$newname" >> $GITHUB_OUTPUT
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° latest
        ln -sf "$newname" "latest-debug.apk"
        
        # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ APK (Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 5 Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ…)
        ls -tp FinancialSuccess-v*-debug.apk | grep -v '/$' | tail -n +6 | xargs -r rm --
        
        echo "ğŸ“± APK prepared: $newname"
        ls -la

    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FinancialSuccess-v${{ steps.version.outputs.version }}-${{ steps.date.outputs.date }}
        path: releases/debug/*.apk
        retention-days: 30

    - name: ğŸ’¾ Commit APK files (only for releases)
      if: steps.should_release.outputs.value == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add releases/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ“± Auto-commit APK v${{ steps.version.outputs.version }} - ${{ steps.date.outputs.date }}
          
          ğŸ”§ Build info:
          - Version: ${{ steps.version.outputs.version }}
          - Version Code: ${{ steps.version.outputs.version_code }}
          - Date: ${{ steps.date.outputs.date }}
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}"
          git push
        fi

  # ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°
  screenshots-phone:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: needs.build-and-test.outputs.should_release == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: FinancialSuccess-v${{ needs.build-and-test.outputs.version }}-${{ needs.build-and-test.outputs.date }}

    - name: ğŸ­ Install Maestro
      run: |
        curl -Ls "https://get.maestro.mobile.dev" | bash
        export PATH="$PATH":"$HOME/.maestro/bin"
        maestro --version

    - name: ï¿½ Debug ADB Devices (before emulator)
      run: adb devices || true
    - name: ï¿½ğŸ“± Start Android Emulator (Phone)
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: arm64-v8a
        profile: Nexus 6
        script: |
          adb devices
          adb shell input keyevent 82
          adb shell input keyevent 82
          sleep 5
          adb devices
          adb logcat -d | tail -n 100

    - name: ğŸ“² Install APK on Phone Emulator
      run: |
        export PATH="$PATH":"$HOME/.maestro/bin"
        adb install releases/debug/*.apk
        adb shell pm list packages | grep financialsuccess
        sleep 3
        adb devices
        adb logcat -d | tail -n 100

    - name: ğŸ“¸ Run Maestro Screenshots (Phone)
      run: |
        export PATH="$PATH":"$HOME/.maestro/bin"
        mkdir -p screenshots/phone
        adb devices
        adb logcat -d | tail -n 100
        if [ -f "maestro/screenshots-stable.yaml" ]; then
          echo "Using stable screenshots configuration"
          maestro test maestro/screenshots-stable.yaml --verbose --format junit --output screenshots/phone/
        else
          echo "Using default screenshots configuration"
          maestro test maestro/screenshots.yaml --verbose --format junit --output screenshots/phone/
        fi
        echo "ğŸ“± Phone screenshots completed!"
        adb devices
        adb logcat -d | tail -n 100

    - name: ğŸ Debug ADB Devices (after screenshots)
      run: adb devices && adb logcat -d | tail -n 100

    - name: ğŸ“¤ Upload Phone Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: phone-screenshots-v${{ needs.build-and-test.outputs.version }}
        path: screenshots/phone/
        retention-days: 30

  # ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ğ½ÑˆĞµÑ‚Ğ°
  screenshots-tablet:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: needs.build-and-test.outputs.should_release == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: FinancialSuccess-v${{ needs.build-and-test.outputs.version }}-${{ needs.build-and-test.outputs.date }}

    - name: ğŸ­ Install Maestro
      run: |
        curl -Ls "https://get.maestro.mobile.dev" | bash
        export PATH="$PATH":"$HOME/.maestro/bin"
        maestro --version

    - name: ï¿½ Debug ADB Devices (after emulator tablet)
      run: adb devices && adb logcat -d | tail -n 100
    - name: ï¿½ğŸ“± Start Android Emulator (Tablet)
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis
        arch: arm64-v8a
        profile: Nexus 10
        script: |
          adb devices
          adb shell input keyevent 82
          adb shell input keyevent 82
          sleep 5
          adb devices
          adb logcat -d | tail -n 100

    - name: ğŸ“² Install APK on Tablet Emulator
      run: |
        export PATH="$PATH":"$HOME/.maestro/bin"
        adb install releases/debug/*.apk
        adb shell pm list packages | grep financialsuccess
        sleep 3
        adb devices
        adb logcat -d | tail -n 100

    - name: ğŸ“¸ Run Maestro Screenshots (Tablet)
      run: |
        export PATH="$PATH":"$HOME/.maestro/bin"
        mkdir -p screenshots/tablet
        adb devices
        adb logcat -d | tail -n 100
        if [ -f "maestro/screenshots-tablet.yaml" ]; then
          echo "Using tablet screenshots configuration"
          maestro test maestro/screenshots-tablet.yaml --verbose --format junit --output screenshots/tablet/
        else
          echo "Using default screenshots configuration for tablet"
          maestro test maestro/screenshots.yaml --verbose --format junit --output screenshots/tablet/
        fi
        echo "ğŸ“± Tablet screenshots completed!"
        adb devices
        adb logcat -d | tail -n 100

    - name: ğŸ Debug ADB Devices (after screenshots tablet)
      run: adb devices && adb logcat -d | tail -n 100

    - name: ğŸ“¤ Upload Tablet Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: tablet-screenshots-v${{ needs.build-and-test.outputs.version }}
        path: screenshots/tablet/
        retention-days: 30

  # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ° Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
  create-release:
    runs-on: ubuntu-latest
    needs: [build-and-test, screenshots-phone, screenshots-tablet]
    if: needs.build-and-test.outputs.should_release == 'true'
    permissions:
      contents: write

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: FinancialSuccess-v${{ needs.build-and-test.outputs.version }}-${{ needs.build-and-test.outputs.date }}

    - name: ğŸ“¥ Download Phone Screenshots
      uses: actions/download-artifact@v4
      with:
        name: phone-screenshots-v${{ needs.build-and-test.outputs.version }}

    - name: ğŸ“¥ Download Tablet Screenshots
      uses: actions/download-artifact@v4
      with:
        name: tablet-screenshots-v${{ needs.build-and-test.outputs.version }}

    - name: ğŸ“¸ Prepare screenshots for repository
      run: |
        mkdir -p screenshots/phone screenshots/tablet
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ñ‹ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸
        if [ -d "screenshots/phone" ]; then
          cp -r screenshots/phone/* screenshots/phone/ 2>/dev/null || true
        fi
        if [ -d "screenshots/tablet" ]; then
          cp -r screenshots/tablet/* screenshots/tablet/ 2>/dev/null || true
        fi
        
        echo "ğŸ“± Phone screenshots:"
        ls -la screenshots/phone/ 2>/dev/null || echo "No phone screenshots"
        echo ""
        echo "ğŸ“± Tablet screenshots:"
        ls -la screenshots/tablet/ 2>/dev/null || echo "No tablet screenshots"

    - name: ğŸ“ Commit Screenshots to Repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add screenshots/
        if git diff --staged --quiet; then
          echo "No screenshots to commit"
        else
          git commit -m "ğŸ“¸ Auto-generated screenshots v${{ needs.build-and-test.outputs.version }} - ${{ needs.build-and-test.outputs.date }}
          
          ğŸ“± Screenshots:
          - Phone: $(ls screenshots/phone/*.png 2>/dev/null | wc -l) files
          - Tablet: $(ls screenshots/tablet/*.png 2>/dev/null | wc -l) files
          - Total: $(find screenshots/ -name "*.png" 2>/dev/null | wc -l) files"
          git push
        fi

    - name: ğŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.build-and-test.outputs.version }}-${{ needs.build-and-test.outputs.date }}
        name: "ğŸ® Financial Success v${{ needs.build-and-test.outputs.version }}"
        body_path: RELEASE_NOTES.md
        files: |
          releases/debug/*.apk
          screenshots/phone/*.png
          screenshots/tablet/*.png
        draft: false
        prerelease: false
        generate_release_notes: false

    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ‰ Release completed successfully!"
        echo "ğŸ“± Version: ${{ needs.build-and-test.outputs.version }}"
        echo "ğŸ”¢ Version Code: ${{ needs.build-and-test.outputs.version_code }}"
        echo "ğŸ“… Date: ${{ needs.build-and-test.outputs.date }}"
        echo "ğŸ“¸ Screenshots generated for phone and tablet"
        echo "ğŸ“¦ APK available in releases/"