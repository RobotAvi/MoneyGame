name: ðŸš€ Stable Build & Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.configureondemand=true
  MAESTRO_CLI_ANALYSIS_NOTIFICATION_DISABLED: "true"

jobs:
  setup-android-sdk:
    runs-on: ubuntu-latest
    outputs:
      sdk-path: /home/runner/android-sdk
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸ—ï¸ Prepare Android SDK directories
        id: set-sdk-path
        run: |
          echo "sdk_path=/home/runner/android-sdk" >> $GITHUB_OUTPUT
          mkdir -p /home/runner/android-sdk
          echo "ANDROID_SDK_ROOT=/home/runner/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_HOME=/home/runner/android-sdk" >> $GITHUB_ENV
      - name: ðŸ› ï¸ Download and install Android commandline tools
        run: |
          set -x
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip cmdline-tools.zip -d $HOME
          mkdir -p $HOME/android-sdk/cmdline-tools
          mv $HOME/cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          echo "==== cmdline-tools structure ===="
          find $HOME/android-sdk/cmdline-tools/
      - name: ðŸ› ï¸ Install Android SDK components
        run: |
          set -x
          export ANDROID_SDK_ROOT=/home/runner/android-sdk
          export ANDROID_HOME=/home/runner/android-sdk
          export PATH="$PATH:/home/runner/android-sdk/emulator:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/cmdline-tools/latest/bin"
          yes | sdkmanager --licenses || { echo "sdkmanager license error"; exit 1; }
          sdkmanager "platform-tools" "emulator" "system-images;android-34;default;x86_64" || { echo "sdkmanager install error"; exit 1; }
          echo "==== system-images after install ===="
          find $ANDROID_SDK_ROOT/system-images/ || echo "system-images dir not found"
      - name: ðŸ“¦ Upload Android SDK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-sdk
          path: ${{ env.ANDROID_SDK_ROOT }}

  # ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  build-and-test:
    runs-on: ubuntu-latest
    needs: setup-android-sdk
    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_HOME: /home/runner/android-sdk
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
      date: ${{ steps.date.outputs.date }}
      apk_path: ${{ steps.apk_path.outputs.path }}
    # should_release Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ changelog

    - name: ðŸ” Determine if this is a release build
      id: should_release
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "value=true" >> $GITHUB_OUTPUT
        else
          echo "value=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ”– Bump version (only for releases)
      id: bump_version
      if: steps.should_release.outputs.value == 'true'
      run: |
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
        CURR_VERSION=$(grep -oP 'versionName\s+"\K[^"]+' app/build.gradle)
        CURR_CODE=$(grep -oP 'versionCode\s+\K[0-9]+' app/build.gradle)
        
        # Ð˜Ð½ÐºÑ€ÐµÐ¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ minor Ð²ÐµÑ€ÑÐ¸ÑŽ (x.y -> x.(y+1))
        MAJOR=$(echo $CURR_VERSION | cut -d. -f1)
        MINOR=$(echo $CURR_VERSION | cut -d. -f2)
        if [ -z "$MINOR" ]; then MINOR=0; fi
        NEW_MINOR=$((MINOR+1))
        NEW_VERSION="$MAJOR.$NEW_MINOR"
        NEW_CODE=$((CURR_CODE+1))
        
        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ build.gradle
        sed -i "s/versionName \"$CURR_VERSION\"/versionName \"$NEW_VERSION\"/" app/build.gradle
        sed -i "s/versionCode $CURR_CODE/versionCode $NEW_CODE/" app/build.gradle
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_code=$NEW_CODE" >> $GITHUB_OUTPUT
        echo "Version bumped: $CURR_VERSION â†’ $NEW_VERSION ($CURR_CODE â†’ $NEW_CODE)"
        
        # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add app/build.gradle
        git commit -m "ðŸ”– Bump version to $NEW_VERSION ($NEW_CODE) [auto]" || echo "No version change to commit"
        git push || echo "No changes to push"

    - name: ðŸ“ Generate release notes (only for releases)
      id: release_notes
      if: steps.should_release.outputs.value == 'true'
      run: |
        echo "## ðŸŽ® Financial Success v${{ steps.bump_version.outputs.new_version }}" > RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ðŸ“… Ð”Ð°Ñ‚Ð° Ñ€ÐµÐ»Ð¸Ð·Ð°: $(date '+%Y-%m-%d %H:%M UTC')" >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ðŸ”„ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:" >> RELEASE_NOTES.md
        git log --oneline -10 >> RELEASE_NOTES.md
        echo "" >> RELEASE_NOTES.md
        echo "### ðŸ“‹ Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð· CHANGELOG.md:" >> RELEASE_NOTES.md
        if [ -f "docs/CHANGELOG.md" ]; then
          tail -n 20 docs/CHANGELOG.md >> RELEASE_NOTES.md
        fi
        cat RELEASE_NOTES.md

    - name: ðŸ“ Commit release notes (only for releases)
      if: steps.should_release.outputs.value == 'true'
      run: |
        git add RELEASE_NOTES.md
        git commit -m "ðŸ“ Update release notes [auto]" || echo "No release notes change to commit"
        git push || echo "No changes to push"

    - name: â˜• Setup JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ðŸ” Check dependencies
      run: |
        echo "ðŸ” Checking dependencies..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Java
        java_version=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2 | cut -d'.' -f1)
        echo "â˜• Java version: $java_version"
        if [ "$java_version" != "21" ]; then
          echo "âš ï¸ Warning: Recommended Java 21, found: $java_version"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° gradlew
        if [ ! -f "gradlew" ]; then
          echo "âŒ Error: gradlew not found"
          exit 1
        fi
        
        echo "âœ… Dependencies checked"

    - name: ðŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: ðŸ“¦ Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.android/build-cache
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ðŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: ðŸ“¦ Download Android SDK artifact
      uses: actions/download-artifact@v4
      with:
        name: android-sdk
        path: ${{ env.ANDROID_SDK_ROOT }}
    - name: ðŸ§¾ Log Android SDK structure
      run: |
        echo "==== ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT ===="
        find $ANDROID_SDK_ROOT/

    - name: ðŸ—ï¸ Log build directories before assemble
      run: |
        echo "==== BEFORE BUILD: app/build/outputs ===="
        find app/build/outputs || echo "No outputs dir yet"

    - name: ðŸ—ï¸ Assemble Debug APK
      run: |
        echo "==== RUN ./gradlew assembleDebug ===="
        ./gradlew assembleDebug --stacktrace --info

    - name: ðŸ—ï¸ Log build directories after assemble
      run: |
        echo "==== AFTER BUILD: app/build/outputs ===="
        find app/build/outputs || echo "No outputs dir"

    - name: ðŸ“± Prepare APK for distribution
      id: apk_path
      run: |
        echo "ðŸ“± Preparing APK for distribution..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ APK ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if [ ! -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "âŒ Error: Debug APK not found"
          ls -la app/build/outputs/apk/debug/ || echo "Debug directory not found"
          exit 1
        fi
        
        mkdir -p releases/debug
        cp app/build/outputs/apk/debug/app-debug.apk releases/debug/
        cd releases/debug
        
        # ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ñ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹ Ð¸ Ð´Ð°Ñ‚Ð¾Ð¹
        newname="FinancialSuccess-v${{ steps.version.outputs.version }}-${{ steps.date.outputs.date }}-debug.apk"
        mv -f app-debug.apk "$newname"
        echo "path=releases/debug/$newname" >> $GITHUB_OUTPUT
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸Ñ‡ÐµÑÐºÑƒÑŽ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° latest
        ln -sf "$newname" "latest-debug.apk"
        
        # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ APK (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 5 Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ…)
        ls -tp FinancialSuccess-v*-debug.apk | grep -v '/$' | tail -n +6 | xargs -r rm -- 2>/dev/null || true
        
        echo "âœ… APK prepared: $newname"
        echo "ðŸ“Š APK files:"
        ls -la

    - name: ðŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FinancialSuccess-v${{ steps.version.outputs.version }}-${{ steps.date.outputs.date }}
        path: releases/debug/*.apk
        retention-days: 30

    - name: ðŸ’¾ Commit APK files (only for releases)
      if: steps.should_release.outputs.value == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add releases/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ“± Auto-commit APK v${{ steps.version.outputs.version }} - ${{ steps.date.outputs.date }}
          
          ðŸ”§ Build info:
          - Version: ${{ steps.version.outputs.version }}
          - Version Code: ${{ steps.version.outputs.version_code }}
          - Date: ${{ steps.date.outputs.date }}
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}"
          git push
        fi

  # ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°
  screenshots-phone:
    runs-on: ubuntu-latest
    needs: [build-and-test, setup-android-sdk]
    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_HOME: /home/runner/android-sdk
    # Ð£Ð±Ñ€Ð°Ð½Ð¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ should_release
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download Android SDK artifact
      uses: actions/download-artifact@v4
      with:
        name: android-sdk
        path: ${{ env.ANDROID_SDK_ROOT }}
    - name: ðŸ§¾ Log Android SDK structure
      run: |
        echo "==== ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT ===="
        find $ANDROID_SDK_ROOT/

    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ adb Ð² PATH (phone)
      run: |
        export PATH="$PATH:/home/runner/android-sdk/platform-tools"
        echo "PATH: $PATH"
        which adb
        adb version

    - name: ðŸŽ­ Install Maestro
      run: |
        curl -Ls "https://get.maestro.mobile.dev" | bash
        export PATH="$PATH:$HOME/.maestro/bin"
        echo "n" | maestro --version

    - name: ðŸ“± Start Android Emulator and Install APK (Phone)
      shell: bash
      env:
        ANDROID_SDK_ROOT: ${{ runner.home }}/android-sdk
        ANDROID_HOME: ${{ runner.home }}/android-sdk
      run: |
        export PATH="$PATH:/home/runner/android-sdk/emulator:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/cmdline-tools/latest/bin"
        set -e
        echo "SDK root: $ANDROID_SDK_ROOT"
        echo "PATH: $PATH"
        ls -la $ANDROID_SDK_ROOT/system-images/android-34/default/x86_64/
        rm -rf ~/.android/avd/*

        # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ AVD, ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if ! avdmanager list avd | grep -q "ci_nexus5"; then
          echo "no" | avdmanager create avd --name "ci_nexus5" --package "system-images;android-34;default;x86_64" --device "Nexus 5"
        fi

        # Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° Ð² Ñ„Ð¾Ð½Ðµ
        emulator -avd "ci_nexus5" -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel off -no-snapshot -no-metrics &
        EMULATOR_PID=$!

        # ÐŸÐ°ÑƒÐ·Ð° Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° (Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ CI)
        sleep 30

        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ð² adb (Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 120Ñ)
        emulator_timeout=120
        emulator_elapsed=0
        for i in {1..60}; do
          if adb devices | grep -q "emulator"; then
            echo "âœ… Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð¿Ð¾ÑÐ²Ð¸Ð»ÑÑ Ð² adb"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð·Ð° $emulator_timeout ÑÐµÐºÑƒÐ½Ð´"
            kill $EMULATOR_PID 2>/dev/null || true
            exit 1
          fi
          sleep 2
          emulator_elapsed=$((emulator_elapsed + 2))
          if [ $((emulator_elapsed % 30)) -eq 0 ]; then
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°: $emulator_elapsed ÑÐµÐºÑƒÐ½Ð´ Ð¸Ð· $emulator_timeout..."
          fi
        done

        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Android (sys.boot_completed, Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 180Ñ)
        boot_timeout=180
        boot_elapsed=0
        for i in {1..90}; do
          if adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ… Android Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
            break
          fi
          if [ $i -eq 90 ]; then
            echo "âŒ Android Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ Ð·Ð° $boot_timeout ÑÐµÐºÑƒÐ½Ð´"
            kill $EMULATOR_PID 2>/dev/null || true
            exit 1
          fi
          sleep 2
          boot_elapsed=$((boot_elapsed + 2))
          if [ $((boot_elapsed % 30)) -eq 0 ]; then
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Android: $boot_elapsed ÑÐµÐºÑƒÐ½Ð´ Ð¸Ð· $boot_timeout..."
          fi
        done

        # Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° ÑÐºÑ€Ð°Ð½Ð°
        adb shell input keyevent 82
        adb shell input keyevent 82
        sleep 2

        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° APK
        if [ ! -f "releases/debug/latest-debug.apk" ]; then
          echo "âŒ Error: latest-debug.apk not found in releases/debug/"
          ls -la releases/debug/
          kill $EMULATOR_PID 2>/dev/null || true
          exit 1
        fi
        adb install releases/debug/latest-debug.apk
        if adb shell pm list packages | grep -q financialsuccess; then
          echo "âœ… APK ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        else
          echo "âŒ Error: APK installation failed"
          kill $EMULATOR_PID 2>/dev/null || true
          exit 1
        fi

        # ... ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ ÑÐ½Ð¸Ð¼Ð°Ñ‚ÑŒÑÑ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑˆÐ°Ð³Ð¾Ð¼ ...

        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
        kill $EMULATOR_PID 2>/dev/null || true
        pkill -f emulator 2>/dev/null || true

    - name: ðŸ“¸ Run Maestro Screenshots (Phone)
      run: |
        export PATH="$PATH:$HOME/.maestro/bin"
        mkdir -p screenshots/phone
        
        # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°
        local config_file="maestro/screenshots-stable.yaml"
        if [ ! -f "$config_file" ]; then
          config_file="maestro/screenshots.yaml"
        fi
        
        if [ -f "$config_file" ]; then
          echo "Using phone screenshots configuration: $config_file"
          maestro test "$config_file" --format junit --output screenshots/phone/
          echo "ðŸ“± Phone screenshots completed!"
        else
          echo "âš ï¸ Warning: Maestro configuration file not found: $config_file"
          echo "ðŸ“± Phone screenshots skipped!"
        fi

    - name: ðŸ“¤ Upload Phone Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: phone-screenshots-v${{ needs.build-and-test.outputs.version }}
        path: screenshots/phone/
        retention-days: 30

  # ÐŸÐ°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð¿Ð»Ð°Ð½ÑˆÐµÑ‚Ð°
  screenshots-tablet:
    runs-on: ubuntu-latest
    needs: [build-and-test, setup-android-sdk]
    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_HOME: /home/runner/android-sdk
    # Ð£Ð±Ñ€Ð°Ð½Ð¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ should_release
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Download Android SDK artifact
      uses: actions/download-artifact@v4
      with:
        name: android-sdk
        path: ${{ env.ANDROID_SDK_ROOT }}
    - name: ðŸ§¾ Log Android SDK structure
      run: |
        echo "==== ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT ===="
        find $ANDROID_SDK_ROOT/

    - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ adb Ð² PATH (tablet)
      run: |
        export PATH="$PATH:/home/runner/android-sdk/platform-tools"
        echo "PATH: $PATH"
        which adb
        adb version

    - name: ðŸŽ­ Install Maestro
      run: |
        curl -Ls "https://get.maestro.mobile.dev" | bash
        export PATH="$PATH:$HOME/.maestro/bin"
        echo "n" | maestro --version

    - name: ðŸ“± Start Android Emulator and Install APK (Tablet)
      shell: bash
      env:
        ANDROID_SDK_ROOT: ${{ runner.home }}/android-sdk
        ANDROID_HOME: ${{ runner.home }}/android-sdk
      run: |
        export PATH="$PATH:/home/runner/android-sdk/emulator:/home/runner/android-sdk/platform-tools:/home/runner/android-sdk/cmdline-tools/latest/bin"
        set -e
        echo "SDK root: $ANDROID_SDK_ROOT"
        echo "PATH: $PATH"
        ls -la $ANDROID_SDK_ROOT/system-images/android-34/default/x86_64/
        rm -rf ~/.android/avd/*

        # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ AVD, ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
        if ! avdmanager list avd | grep -q "ci_nexus10"; then
          echo "no" | avdmanager create avd --name "ci_nexus10" --package "system-images;android-34;default;x86_64" --device "Nexus 10"
        fi

        # Ð—Ð°Ð¿ÑƒÑÐº ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° Ð² Ñ„Ð¾Ð½Ðµ
        emulator -avd "ci_nexus10" -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel off -no-snapshot -no-metrics &
        EMULATOR_PID=$!

        # ÐŸÐ°ÑƒÐ·Ð° Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° (Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ CI)
        sleep 30

        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ð² adb (Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 120Ñ)
        emulator_timeout=120
        emulator_elapsed=0
        for i in {1..60}; do
          if adb devices | grep -q "emulator"; then
            echo "âœ… Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð¿Ð¾ÑÐ²Ð¸Ð»ÑÑ Ð² adb"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð·Ð° $emulator_timeout ÑÐµÐºÑƒÐ½Ð´"
            kill $EMULATOR_PID 2>/dev/null || true
            exit 1
          fi
          sleep 2
          emulator_elapsed=$((emulator_elapsed + 2))
          if [ $((emulator_elapsed % 30)) -eq 0 ]; then
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°: $emulator_elapsed ÑÐµÐºÑƒÐ½Ð´ Ð¸Ð· $emulator_timeout..."
          fi
        done

        # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Android (sys.boot_completed, Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 180Ñ)
        boot_timeout=180
        boot_elapsed=0
        for i in {1..90}; do
          if adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ… Android Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
            break
          fi
          if [ $i -eq 90 ]; then
            echo "âŒ Android Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ Ð·Ð° $boot_timeout ÑÐµÐºÑƒÐ½Ð´"
            kill $EMULATOR_PID 2>/dev/null || true
            exit 1
          fi
          sleep 2
          boot_elapsed=$((boot_elapsed + 2))
          if [ $((boot_elapsed % 30)) -eq 0 ]; then
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Android: $boot_elapsed ÑÐµÐºÑƒÐ½Ð´ Ð¸Ð· $boot_timeout..."
          fi
        done

        # Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ° ÑÐºÑ€Ð°Ð½Ð°
        adb shell input keyevent 82
        adb shell input keyevent 82
        sleep 2

        # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° APK
        if [ ! -f "releases/debug/latest-debug.apk" ]; then
          echo "âŒ Error: latest-debug.apk not found in releases/debug/"
          ls -la releases/debug/
          kill $EMULATOR_PID 2>/dev/null || true
          exit 1
        fi
        adb install releases/debug/latest-debug.apk
        if adb shell pm list packages | grep -q financialsuccess; then
          echo "âœ… APK ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        else
          echo "âŒ Error: APK installation failed"
          kill $EMULATOR_PID 2>/dev/null || true
          exit 1
        fi

        # ... ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ ÑÐ½Ð¸Ð¼Ð°Ñ‚ÑŒÑÑ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ ÑˆÐ°Ð³Ð¾Ð¼ ...

        # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
        kill $EMULATOR_PID 2>/dev/null || true
        pkill -f emulator 2>/dev/null || true

    - name: ðŸ“¸ Run Maestro Screenshots (Tablet)
      run: |
        export PATH="$PATH:$HOME/.maestro/bin"
        mkdir -p screenshots/tablet
        
        # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ð»Ð°Ð½ÑˆÐµÑ‚Ð°
        local config_file="maestro/screenshots-tablet.yaml"
        if [ ! -f "$config_file" ]; then
          config_file="maestro/screenshots.yaml"
        fi
        
        if [ -f "$config_file" ]; then
          echo "Using tablet screenshots configuration: $config_file"
          maestro test "$config_file" --format junit --output screenshots/tablet/
          echo "ðŸ“± Tablet screenshots completed!"
        else
          echo "âš ï¸ Warning: Maestro configuration file not found: $config_file"
          echo "ðŸ“± Tablet screenshots skipped!"
        fi

    - name: ðŸ“¤ Upload Tablet Screenshots
      uses: actions/upload-artifact@v4
      with:
        name: tablet-screenshots-v${{ needs.build-and-test.outputs.version }}
        path: screenshots/tablet/
        retention-days: 30

  # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ±Ð¾Ñ€ÐºÐ° Ñ€ÐµÐ»Ð¸Ð·Ð°
  create-release:
    runs-on: ubuntu-latest
    needs: [build-and-test, screenshots-phone, screenshots-tablet]
    # Ð£Ð±Ñ€Ð°Ð½Ð¾ ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ should_release
    permissions:
      contents: write

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¥ Download APK
      uses: actions/download-artifact@v4
      with:
        name: FinancialSuccess-v${{ needs.build-and-test.outputs.version }}-${{ needs.build-and-test.outputs.date }}

    - name: ðŸ“¥ Download Phone Screenshots
      uses: actions/download-artifact@v4
      with:
        name: phone-screenshots-v${{ needs.build-and-test.outputs.version }}

    - name: ðŸ“¥ Download Tablet Screenshots
      uses: actions/download-artifact@v4
      with:
        name: tablet-screenshots-v${{ needs.build-and-test.outputs.version }}

    - name: ðŸ“¸ Prepare screenshots for repository
      run: |
        mkdir -p screenshots/phone screenshots/tablet
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ð¿ÐºÐ¸
        if [ -d "screenshots/phone" ]; then
          cp -r screenshots/phone/* screenshots/phone/ 2>/dev/null || true
        fi
        if [ -d "screenshots/tablet" ]; then
          cp -r screenshots/tablet/* screenshots/tablet/ 2>/dev/null || true
        fi
        
        echo "ðŸ“± Phone screenshots:"
        ls -la screenshots/phone/ 2>/dev/null || echo "No phone screenshots"
        echo ""
        echo "ðŸ“± Tablet screenshots:"
        ls -la screenshots/tablet/ 2>/dev/null || echo "No tablet screenshots"

    - name: ðŸ“ Commit Screenshots to Repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add screenshots/
        if git diff --staged --quiet; then
          echo "No screenshots to commit"
        else
          git commit -m "ðŸ“¸ Auto-generated screenshots v${{ needs.build-and-test.outputs.version }} - ${{ needs.build-and-test.outputs.date }}
          
          ðŸ“± Screenshots:
          - Phone: $(ls screenshots/phone/*.png 2>/dev/null | wc -l) files
          - Tablet: $(ls screenshots/tablet/*.png 2>/dev/null | wc -l) files
          - Total: $(find screenshots/ -name "*.png" 2>/dev/null | wc -l) files"
          git push
        fi

    - name: ðŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.build-and-test.outputs.version }}-${{ needs.build-and-test.outputs.date }}
        name: "ðŸŽ® Financial Success v${{ needs.build-and-test.outputs.version }}"
        body_path: RELEASE_NOTES.md
        files: |
          releases/debug/*.apk
          screenshots/phone/*.png
          screenshots/tablet/*.png
        draft: false
        prerelease: false
        generate_release_notes: false

    - name: ðŸ“Š Build Summary
      run: |
        echo "ðŸŽ‰ Release completed successfully!"
        echo ""
        echo "ï¿½ Results:"
        echo "ï¿½ï¿½ Version: ${{ needs.build-and-test.outputs.version }}"
        echo "ðŸ”¢ Version Code: ${{ needs.build-and-test.outputs.version_code }}"
        echo "ðŸ“… Date: ${{ needs.build-and-test.outputs.date }}"
        echo "ï¿½ APK: releases/debug/FinancialSuccess-v${{ needs.build-and-test.outputs.version }}-${{ needs.build-and-test.outputs.date }}-debug.apk"
        echo "ðŸ“¸ Phone screenshots: screenshots/phone/"
        echo "ðŸ“¸ Tablet screenshots: screenshots/tablet/"
        echo ""
        echo "ï¿½ Files:"
        ls -la releases/debug/ || echo "No APK files found"
        echo ""
        echo "ðŸ“¸ Phone screenshots:"
        ls -la screenshots/phone/ 2>/dev/null || echo "No phone screenshots"
        echo ""
        echo "ðŸ“¸ Tablet screenshots:"
        ls -la screenshots/tablet/ 2>/dev/null || echo "No tablet screenshots"
