#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Android ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð¾Ð¼ Ð² CI/CD

set -e

echo "ðŸ”§ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Android ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°..."

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
check_emulator_status() {
    echo "ðŸ“± ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°..."
    
    if adb devices | grep -q "emulator-5554.*device"; then
        echo "âœ… Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²"
        return 0
    elif adb devices | grep -q "emulator-5554.*offline"; then
        echo "âš ï¸  Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð¾Ñ„Ð»Ð°Ð¹Ð½"
        return 1
    else
        echo "âŒ Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        return 1
    fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
check_system_boot() {
    echo "ðŸ”„ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
    
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if adb shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
            echo "âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°"
            return 0
        else
            echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹... ($attempt/$max_attempts)"
            sleep 5
            attempt=$((attempt + 1))
        fi
    done
    
    echo "âŒ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»Ð°ÑÑŒ Ð·Ð° Ð¾Ñ‚Ð²ÐµÐ´ÐµÐ½Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ"
    return 1
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ APK
test_apk_installation() {
    local apk_path="$1"
    
    if [ -z "$apk_path" ]; then
        echo "âŒ ÐŸÑƒÑ‚ÑŒ Ðº APK Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½"
        return 1
    fi
    
    echo "ðŸ“¦ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ APK: $apk_path"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
    if [ ! -f "$apk_path" ]; then
        echo "âŒ APK Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $apk_path"
        return 1
    fi
    
    # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ APK
    if adb install -r "$apk_path"; then
        echo "âœ… APK ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾
        if adb shell pm list packages | grep -q "com.financialsuccess.game"; then
            echo "âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ"
            return 0
        else
            echo "âš ï¸  ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²"
            return 1
        fi
    else
        echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ APK"
        return 1
    fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Maestro
test_maestro() {
    echo "ðŸŽ­ Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Maestro..."
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Maestro ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
    if ! command -v maestro &> /dev/null; then
        echo "âŒ Maestro Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        return 1
    fi
    
    echo "âœ… Maestro Ð½Ð°Ð¹Ð´ÐµÐ½: $(maestro --version)"
    
    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚ÐµÑÑ‚
    cat > /tmp/test-maestro.yaml << 'EOF'
appId: com.financialsuccess.game
name: Test Maestro
outputDir: /tmp/maestro-test

- launchApp
- takeScreenshot: "test_screenshot"
EOF
    
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚
    if maestro test /tmp/test-maestro.yaml; then
        echo "âœ… Maestro Ñ‚ÐµÑÑ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½
        if [ -f "/tmp/maestro-test/test_screenshot.png" ]; then
            echo "âœ… Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½"
            return 0
        else
            echo "âš ï¸  Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½"
            return 1
        fi
    else
        echo "âŒ Maestro Ñ‚ÐµÑÑ‚ Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½"
        return 1
    fi
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
main() {
    echo "ðŸš€ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°..."
    
    # Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
    if ! check_emulator_status; then
        echo "âŒ Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²"
        exit 1
    fi
    
    # Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
    if ! check_system_boot; then
        echo "âŒ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»Ð°ÑÑŒ"
        exit 1
    fi
    
    # Ð¨Ð°Ð³ 3: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ APK (ÐµÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½ Ð¿ÑƒÑ‚ÑŒ)
    if [ -n "$1" ]; then
        if ! test_apk_installation "$1"; then
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ APK"
            exit 1
        fi
    else
        echo "â„¹ï¸  ÐŸÑ€Ð¾Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ APK (Ð¿ÑƒÑ‚ÑŒ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½)"
    fi
    
    # Ð¨Ð°Ð³ 4: Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Maestro
    if ! test_maestro; then
        echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Maestro"
        exit 1
    fi
    
    echo "ðŸŽ‰ Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
    echo "âœ… Ð­Ð¼ÑƒÐ»ÑÑ‚Ð¾Ñ€ ÑÑ‚Ð°Ð±Ð¸Ð»ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ"
}

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸
case "${1:-}" in
    --help|-h)
        echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: $0 [Ð¿ÑƒÑ‚ÑŒ_Ðº_apk]"
        echo ""
        echo "Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÑ‚ ÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Android ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°:"
        echo "  - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¼ÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°"
        echo "  - ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹"
        echo "  - Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÑ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ APK (ÐµÑÐ»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½ Ð¿ÑƒÑ‚ÑŒ)"
        echo "  - Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Maestro"
        echo ""
        echo "ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:"
        echo "  $0                                    # Ð‘Ð°Ð·Ð¾Ð²Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ"
        echo "  $0 app/build/outputs/apk/debug/app-debug.apk  # Ð¡ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ APK"
        exit 0
        ;;
    *)
        main "$@"
        ;;
esac